{% extends "base.html" %}

{% block title %}Knowledge Library - Personal Dashboard{% endblock %}

{% block head_extra %}
<style>
    .library-container {
        display: grid;
        grid-template-columns: 250px 1fr;
        gap: 20px;
        height: calc(100vh - 180px);
    }
    
    .library-sidebar {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: 20px;
        overflow-y: auto;
    }
    
    .library-content {
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        padding: 20px;
        overflow-y: auto;
    }
    
    .category-list {
        list-style: none;
        padding: 0;
    }
    
    .category-item {
        padding: 12px 16px;
        margin-bottom: 5px;
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .category-item:hover {
        background: rgba(99, 102, 241, 0.1);
    }
    
    .category-item.active {
        background: var(--accent-primary);
        color: white;
    }
    
    .knowledge-card {
        background: rgba(255, 255, 255, 0.05);
        border-radius: var(--radius-lg);
        padding: 20px;
        margin-bottom: 20px;
        border-left: 4px solid var(--accent-primary);
    }
    
    .knowledge-card h3 {
        margin-top: 0;
        color: var(--accent-primary);
    }
    
    .search-box {
        margin-bottom: 20px;
    }
    
    .tag {
        display: inline-block;
        background: rgba(99, 102, 241, 0.2);
        color: var(--accent-primary);
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.85rem;
        margin-right: 5px;
        margin-bottom: 5px;
    }
    
    .ai-status {
        padding: 10px;
        border-radius: var(--radius-sm);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .ai-status.online {
        background: rgba(16, 185, 129, 0.1);
        border-left: 3px solid var(--accent-success);
    }
    
    .ai-status.offline {
        background: rgba(245, 158, 11, 0.1);
        border-left: 3px solid var(--accent-warning);
    }
</style>
{% endblock %}

{% block content %}
<div class="library-header">
    <h1><i class="fas fa-book"></i> Knowledge Library</h1>
    <p class="subtitle">Reference materials for health, law, philosophy, and science</p>
    
    <div class="ai-status {{ 'online' if ollama_available else 'offline' }}">
        <i class="fas fa-robot"></i>
        <span>AI Assistant: {{ 'Online (Ollama)' if ollama_available else 'Offline - Using Library' }}</span>
    </div>
</div>

<div class="library-container">
    <div class="library-sidebar">
        <div class="search-box">
            <input type="text" id="librarySearch" placeholder="Search knowledge..." 
                   onkeyup="searchLibrary()">
        </div>
        
        <h3>Categories</h3>
        <ul class="category-list">
            <li class="category-item active" data-category="all">
                <i class="fas fa-layer-group"></i> All Topics
            </li>
            <li class="category-item" data-category="health">
                <i class="fas fa-heartbeat"></i> Health & Wellness
            </li>
            <li class="category-item" data-category="law">
                <i class="fas fa-gavel"></i> Philippine Law
            </li>
            <li class="category-item" data-category="philosophy">
                <i class="fas fa-brain"></i> Philosophy
            </li>
            <li class="category-item" data-category="science">
                <i class="fas fa-flask"></i> Science & Facts
            </li>
            <li class="category-item" data-category="productivity">
                <i class="fas fa-tasks"></i> Productivity
            </li>
            <li class="category-item" data-category="finance">
                <i class="fas fa-coins"></i> Personal Finance
            </li>
        </ul>
        
        <div class="quick-actions">
            <h3>Quick Actions</h3>
            <button class="btn-secondary" onclick="generateDailyInsight()">
                <i class="fas fa-lightbulb"></i> Generate Insight
            </button>
            <button class="btn-secondary" onclick="exportLibrary()">
                <i class="fas fa-download"></i> Export
            </button>
        </div>
    </div>
    
    <div class="library-content">
        <div id="knowledgeContent">
            {% for item in knowledge_items %}
            <div class="knowledge-card" data-categories="{{ item.categories|join(' ') }}" 
                 data-tags="{{ item.tags|join(' ') }}">
                <h3>{{ item.title }}</h3>
                <div class="meta">
                    <span class="date">{{ item.date }}</span>
                    {% for tag in item.tags %}
                    <span class="tag">{{ tag }}</span>
                    {% endfor %}
                </div>
                <div class="content">
                    {{ item.content|safe }}
                </div>
                {% if item.source %}
                <div class="source">
                    <small>Source: {{ item.source }}</small>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Category filtering
        document.querySelectorAll('.category-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.category-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                
                const category = this.dataset.category;
                filterByCategory(category);
            });
        });
    });
    
    function filterByCategory(category) {
        const cards = document.querySelectorAll('.knowledge-card');
        
        cards.forEach(card => {
            if (category === 'all' || card.dataset.categories.includes(category)) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }
    
    function searchLibrary() {
        const searchTerm = document.getElementById('librarySearch').value.toLowerCase();
        const cards = document.querySelectorAll('.knowledge-card');
        
        cards.forEach(card => {
            const text = card.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }
    
    function generateDailyInsight() {
        const categories = ['health', 'law', 'philosophy', 'science'];
        const randomCategory = categories[Math.floor(Math.random() * categories.length)];
        
        fetch(`/api/library/insight/${randomCategory}`)
            .then(r => r.json())
            .then(data => {
                alert(`Daily ${randomCategory} insight:\n\n${data.insight}`);
            });
    }
    
    function exportLibrary() {
        fetch('/api/library/export')
            .then(r => r.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'knowledge-library.json';
                a.click();
            });
    }
</script>
{% endblock %}